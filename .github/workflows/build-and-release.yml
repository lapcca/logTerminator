name: Build and Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    strategy:
      fail-fast: false
      matrix:
        platform:
          - os: windows-latest
            target: x86_64-pc-windows-msvc

    runs-on: ${{ matrix.platform.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform.target }}

      - name: Install dependencies (Ubuntu only)
        if: matrix.platform.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Install frontend dependencies
        run: pnpm install

      - name: Build application
        run: pnpm tauri build
        env:
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}

      - name: Get version
        id: get_version
        shell: bash
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "release_name=v$VERSION" >> $GITHUB_OUTPUT

      - name: Get changelog
        id: changelog
        shell: bash
        run: |
          # Get the latest tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LATEST_TAG" ]; then
            # No tags yet, get all commits
            COMMITS=$(git log --pretty=format:"- %s (%h)" --reverse)
          else
            # Get commits since last tag
            COMMITS=$(git log ${LATEST_TAG}..HEAD --pretty=format:"- %s (%h)" --reverse)
          fi

          # Save to file
          echo "$COMMITS" > changelog.md

          # Set output
          {
            echo 'changelog<<EOF'
            cat changelog.md
            echo EOF
          } >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ steps.get_version.outputs.release_name }}
          tag_name: ${{ steps.get_version.outputs.release_name }}
          files: |
            src-tauri/target/${{ matrix.platform.target }}/release/bundle/nsis/logTerminator_*.nsis.exe
            src-tauri/target/${{ matrix.platform.target }}/release/logterminator.exe
          draft: false
          prerelease: false
          body: |
            ## üì¶ logTerminator ${{ steps.get_version.outputs.release_name }}

            ### üìù Changes

            ${{ steps.changelog.outputs.changelog }}

            ### ‚¨áÔ∏è Downloads

            | File | Description |
            |------|-------------|
            | `logTerminator_*_x64-setup.exe` | **Installer** (Recommended) - Includes all dependencies |
            | `logterminator.exe` | **Portable** - Standalone executable |

            ### üöÄ Installation

            **Option 1: Installer (Recommended)**
            1. Download `logTerminator_*_x64-setup.exe`
            2. Run the installer
            3. Launch logTerminator from the Start menu or desktop shortcut

            **Option 2: Portable**
            1. Download `logterminator.exe`
            2. Place it in any folder
            3. Run the executable directly

            ### ‚ö†Ô∏è Windows SmartScreen Warning

            When you first run logTerminator, Windows may show a SmartScreen warning. This is because the executable is not digitally signed. Click "More info" and then "Run anyway" to proceed.

            ---
            **Full Changelog**: https://github.com/lapcca/logTerminator/commits/${{ steps.get_version.outputs.release_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
